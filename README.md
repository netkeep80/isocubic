[![Gitpod ready-to-code](https://img.shields.io/badge/Gitpod-ready--to--code-blue?logo=gitpod)](https://gitpod.io/#https://github.com/netkeep80/isocubic)
# isocubic

Веб-редактор параметрических кубиков для создания изометрических 3D-миров.

## О проекте

**isocubic** — это веб-приложение для создания и редактирования параметрических воксельных кубиков. Проект вдохновлён классическими играми Diablo 1 и X-COM: UFO, но использует современный стек технологий для работы в браузере.

### Ключевые особенности

- **Параметрическое описание** — кубики хранятся как компактные JSON-конфиги, а не как тяжёлые текстуры
- **Процедурная генерация** — градиенты, шум Perlin/Worley и другие эффекты создаются в реальном времени
- **ИИ-генерация** — создание кубиков по текстовому описанию с помощью TinyLLM
- **Бесшовная сшивка** — соседние кубики плавно соединяются без видимых границ
- **Высокая производительность** — 60 FPS на мобильных устройствах
- **Работает offline** — PWA-приложение работает без интернета после первой загрузки

## Архитектура

isocubic использует **параметрический подход** для описания кубиков:

```
┌─────────────────────────────────────────────────────────────┐
│                     JSON-конфиг кубика                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ Base Color  │  │  Gradients  │  │   Procedural Noise  │ │
│  │ [R, G, B]   │  │  axis, shift │  │  type, scale, mask  │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    GLSL-шейдер (GPU)                        │
│  • Расчёт цвета по параметрам                               │
│  • Генерация шума в реальном времени                        │
│  • Интерполяция на границах                                 │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                  Three.js / WebGL рендеринг                 │
│  • Изометрическая камера                                    │
│  • Освещение и тени                                         │
│  • Интерактивное управление                                 │
└─────────────────────────────────────────────────────────────┘
```

### Формат конфигурации кубика

```json
{
  "id": "stone_moss_001",
  "prompt": "каменная кладка с мхом",
  "base": {
    "color": [0.65, 0.55, 0.45],
    "roughness": 0.8,
    "transparency": 1.0
  },
  "gradients": [
    {
      "axis": "y",
      "factor": 0.3,
      "color_shift": [0.2, 0.35, 0.15]
    }
  ],
  "noise": {
    "type": "perlin",
    "scale": 8.0,
    "octaves": 4,
    "persistence": 0.6,
    "mask": "bottom_40%"
  },
  "physics": {
    "material": "stone",
    "density": 2.5,
    "break_pattern": "crumble"
  }
}
```

## Технологический стек

| Технология | Назначение |
|------------|------------|
| React | UI-компоненты |
| TypeScript | Типизация |
| Three.js | 3D-рендеринг |
| @react-three/fiber | React-обёртка для Three.js |
| @react-three/drei | Готовые компоненты для Three.js |
| Tailwind CSS | Стилизация |
| TensorFlow.js | Клиентский ИИ (TinyLLM) |
| Vite | Сборка |
| Vitest | Тестирование |

## Быстрый старт

### Требования

- Node.js >= 18
- npm >= 9

### Установка

```bash
# Клонирование репозитория
git clone https://github.com/netkeep80/isocubic.git
cd isocubic

# Установка зависимостей
npm install

# Запуск в режиме разработки
npm run dev
```

### Команды

| Команда | Описание |
|---------|----------|
| `npm run dev` | Запуск dev-сервера |
| `npm run build` | Сборка для production |
| `npm run preview` | Предпросмотр production-сборки |
| `npm run test` | Запуск тестов |
| `npm run lint` | Проверка кода |

## Структура проекта

```
isocubic/
├── src/
│   ├── components/        # React-компоненты
│   │   ├── ParametricCube.tsx # Параметрический куб с шейдером (с поддержкой LOD)
│   │   ├── EnergyCube.tsx     # Энергетический куб с FFT визуализацией
│   │   ├── CubePreview.tsx    # 3D-превью куба с интерактивным управлением
│   │   ├── CubeGrid.tsx       # Сетка кубов с бесшовной сшивкой
│   │   ├── CubeStack.tsx      # Вертикальные стопки кубов с плавными переходами
│   │   ├── LODCubeGrid.tsx    # Сетка кубов с автоматическим LOD управлением
│   │   ├── ParamEditor.tsx    # Редактор параметров (TODO)
│   │   ├── PromptGenerator.tsx # Генерация по промпту с расширенными режимами
│   │   ├── Gallery.tsx        # Галерея примеров
│   │   └── ExportPanel.tsx    # Экспорт/импорт
│   ├── shaders/           # GLSL-шейдеры
│   │   ├── parametric-cube.glsl  # Исходный GLSL код
│   │   ├── parametric-cube.ts    # TypeScript модуль для Three.js
│   │   ├── energy-cube.glsl      # Энергетический шейдер
│   │   └── energy-cube.ts        # TypeScript модуль для энергетических кубов
│   ├── lib/               # Утилиты
│   │   ├── shader-utils.ts    # Утилиты для шейдеров (с поддержкой LOD)
│   │   ├── lod-system.ts      # LOD-система для оптимизации рендеринга
│   │   ├── webgpu-compute.ts  # WebGPU compute-шейдеры для параллельной генерации текстур
│   │   ├── tinyLLM.ts         # ИИ-генератор с расширенными функциями
│   │   ├── storage.ts         # Работа с хранилищем
│   │   ├── validation.ts      # Валидация схемы
│   │   ├── fft-wasm.ts        # FFT модуль (WASM + JS fallback)
│   │   ├── energyPhysics.ts   # Физика энергии для магических объектов
│   │   └── collaboration.ts   # Модуль коллаборативного редактирования
│   ├── types/             # TypeScript-типы
│   │   ├── cube.ts
│   │   ├── lod.ts             # Типы для LOD-системы
│   │   ├── stack.ts           # Типы для системы стопок кубиков
│   │   └── collaboration.ts   # Типы для коллаборации и мультиплеера
│   └── App.tsx
├── wasm-fft/              # Rust WASM модуль для FFT
│   ├── Cargo.toml             # Rust конфигурация
│   ├── src/lib.rs             # Реализация 3D FFT
│   └── README.md              # Документация WASM модуля
├── public/
│   └── model/             # Модель TinyLLM
├── examples/              # Примеры конфигов
├── ANALYSIS.md            # Анализ подходов
├── TASKS.md               # План задач MVP
└── README.md
```

## Использование

### Создание кубика по промпту

1. Введите описание в текстовое поле: *"каменная стена с трещинами и мхом"*
2. Нажмите "Создать по описанию"
3. ИИ сгенерирует параметры автоматически

### Ручное редактирование

1. Выберите кубик из галереи или создайте новый
2. Настройте параметры в панели справа:
   - **Базовый цвет** — основной цвет материала
   - **Градиенты** — изменение цвета по осям
   - **Шум** — текстура поверхности
   - **Физика** — свойства материала
3. Сохраните или экспортируйте результат

### Экспорт

- **JSON** — для использования в других проектах
- **PNG** — скриншот превью
- **LocalStorage** — автосохранение в браузере

## Roadmap

### Фаза 1: MVP (завершена ✓)

- [x] Анализ подходов (ANALYSIS.md)
- [x] Инициализация проекта
- [x] JSON-схема конфигов
- [x] Базовый шейдер
- [x] 3D-превью
- [x] Редактор параметров
- [x] Генерация по промпту (TinyLLM)
- [x] Сшивка границ
- [x] Экспорт/импорт
- [x] Галерея примеров
- [x] Мобильная оптимизация
- [x] Тестирование и документация
- [x] Деплой

### Фаза 2: FFT для магических объектов (завершена ✓)

- [x] Планирование задач Фазы 2 (TASKS.md)
- [x] WASM-модуль для FFT (ISSUE 13)
- [x] Шейдер энергетической визуализации (ISSUE 14)
- [x] Физика энергии (ISSUE 15)
- [x] Интеграция с боем и разрушением (ISSUE 16)

### Фаза 3: Оптимизация (завершена ✓)

- [x] LOD-система (ISSUE 17)
- [x] WebGPU compute-шейдеры (ISSUE 18)
- [x] Расширенная ИИ-модель (ISSUE 19)
- [x] Система "стопок кубиков" (ISSUE 20)

### Фаза 4: Мультиплеер и коллаборация (текущая)

- [x] Основы коллаборативной архитектуры (ISSUE 21)
- [x] WebSocket интеграция (ISSUE 22)
- [ ] UI для совместной работы (ISSUE 23)
- [ ] Серверная часть (ISSUE 24, опционально)

## Деплой

### GitHub Pages

Приложение автоматически развёртывается на GitHub Pages при пуше в ветку `main`.

**Публичный URL**: [https://netkeep80.github.io/isocubic/](https://netkeep80.github.io/isocubic/)

Workflow для деплоя:
1. Push в `main` запускает GitHub Actions
2. Выполняется сборка и тестирование
3. Собранные файлы публикуются на GitHub Pages

### Ручной деплой

Для ручной сборки и деплоя:

```bash
# Сборка для production
npm run build

# Предпросмотр production-сборки локально
npm run preview
```

Собранные файлы находятся в папке `dist/`.

## Документация

- [API Reference](docs/API.md) — полное описание компонентов и модулей
- [ANALYSIS.md](ANALYSIS.md) — анализ подходов к реализации
- [TASKS.md](TASKS.md) — план задач MVP

## Тестирование

Проект покрыт тестами с использованием Vitest:

```bash
# Запуск тестов
npm test

# Запуск тестов в watch-режиме
npm run test:watch

# Запуск с покрытием
npm run test:coverage
```

**Текущее покрытие:**
- 977 тестов
- Unit-тесты для типов, валидации, хранилища, производительности, физики энергии
- Тесты модуля коллаборации (сессии, участники, синхронизация, конфликты)
- Тесты WebSocket клиента (подключение, сообщения, реконнект, fallback на polling)
- Интеграционные тесты для компонентов Gallery, ExportPanel
- Тесты расширенной ИИ-модели (пакетная генерация, группы, fine-tuning)
- E2E тесты для полных workflow редактирования

## Вклад в проект

Мы приветствуем вклад в развитие isocubic!

1. Форкните репозиторий
2. Создайте ветку для фичи: `git checkout -b feature/amazing-feature`
3. Закоммитьте изменения: `git commit -m 'Add amazing feature'`
4. Запушьте в ветку: `git push origin feature/amazing-feature`
5. Откройте Pull Request

### Правила

- Следуйте code style (ESLint + Prettier)
- Покрывайте новый код тестами
- Обновляйте документацию при необходимости
- Пишите понятные commit messages

## Лицензия

Unlicense license — см. файл [LICENSE](LICENSE)

## Связь

- **GitHub Issues** — для багов и предложений
- **Discussions** — для вопросов и обсуждений

---

*Создано с использованием современных веб-технологий для работы в любом браузере.*
